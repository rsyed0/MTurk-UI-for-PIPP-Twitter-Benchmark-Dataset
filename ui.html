<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://assets.crowd.aws/crowd-html-elements.js"> </script>
    <script type="text/javascript">

        let originalText = "";
        let highlighted_words = new Set();
        let question_number = 1;
        let userSelection = "";
        let trigger_word = "";
        let trigger_range = "";
        let word_num = "";
        let triggerword_token_qsn = "";

        let field_names = ['${text1}', '${text2}', '${text3}', '${text4}', '${text5}'];
        let ids = ['${id1}', '${id2}', '${id3}', '${id4}', '${id5}'];
        let annotations_list = ['[{"event": "symptom","trigger":"69-73","person":"","symptom":"64-67","disease":"","place":"","time":"","duration":"","information":""}, {"event": "symptom","trigger":"69-76","person":"","symptom":"cough | fever","disease":"","place":"","time":"","duration":"","information":""}]', '[{"event": "symptom", "trigger":"69-73","person":"","symptom":"64-67","disease":"","place":"","time":"","duration":"","information":""}]', '[{"event": "symptom", "trigger":"69-73","person":"","symptom":"64-65","disease":"","place":"","time":"","duration":"","information":""}]', '[{"event": "symptom", "trigger":"69-73","person":"","symptom":"64-67","disease":"","place":"","time":"","duration":"","information":""}]', '[{"event": "symptom", "trigger":"69-73","person":"","symptom":"54-67","disease":"","place":"","time":"11","duration":"","information":""}]'];
        // let annotations_list = ['${annotations1}', '${annotations2}', '${annotations3}', '${annotations4}', '${annotations5}']; // TODO: switch this back out when pasting onto live site
        let current_table = "small";
        let output_obj = {};


        window.onload = function () {


            for (let i = 1; i <= field_names.length; i++) {
                let ele = document.createElement("H2");
                ele.textContent = field_names[i - 1];
                ele.setAttribute('id', 'question' + String(i));
                document.querySelector("#questions").appendChild(ele);

                const annotations = JSON.parse(annotations_list[i - 1]);

                const annotation_div = document.createElement('div');
                annotation_div.setAttribute('id', `annotation_div` + i);

                // Populate the div with p elements
                for (let j = 0; j < annotations.length; j++) {
                    annotation_div.innerHTML += parseAnnotationJSONToHtml(annotations[j], i + "_" + j);

                    output_obj[i + "_" + j] = {
                        text: field_names[i - 1],
                        annotation: annotations[j],
                        correct: true,
                        explanation: null,
                    };
                }
                document.querySelector("#annotations").appendChild(annotation_div);

                // attach onchange event listener to the parent because the children are dynamically updated
                parent_annotation_div = document.getElementById("text_annotations");
                parent_annotation_div.addEventListener("input", function (event) {
                    // TODO: add the dynamic shit with the checkbox here
                    if (event.target.type == "checkbox") {
                        output_obj[event.target.name]["correct"] = !event.target.checked;
                    }

                    // Check if the target of the event is a textarea
                    if (event.target.tagName.toLowerCase() === "textarea") {
                        // Get the trimmed text content of the textarea
                        var text = event.target.value.trim();

                        // update output object
                        output_obj[event.target.name]["explanation"] = text
                    }
                });

            }

            document.getElementById("text_question").innerHTML = document.getElementById("question" + String(question_number)).innerHTML;
            document.getElementById("text_annotations").innerHTML = document.getElementById("annotation_div" + String(question_number)).innerHTML;
            originalText = document.getElementById("text_question").innerHTML;

            replace();
            document.getElementById("previous_btn").disabled = true;
            document.getElementById("qsn_num").innerHTML = question_number + '/' + field_names.length;
            document.getElementById("submit_hit").disabled = (String(field_names.length) != String(question_number));
        }

        // Function to convert an annotated event in JSON to HTML
        function parseAnnotationJSONToHtml(jsonData, id) {
            var html = `<div id='` + id + `' style='border:1px solid black; width: 400px ;padding: 10px; margin: 10px; display: flex; justify-content: space-between;'>`;


            html += "<div class='annotation_arguments' style='margin-right: 10px; width: 50%;'>";

            console.log(jsonData);

            for (var key in jsonData) {
                if (jsonData.hasOwnProperty(key)) {
                    // Create a <p> element for each key-value pair
                    const parts = jsonData[key].split('|');
                    // Map over the parts and wrap each in a span tag with the specified style
                    const formattedParts = parts.map(part => `<span style='color:#1ec211'>${part.trim()}</span>`);
                    html += "<p style='margin: 0px'>" + key + ": " + formattedParts.join(", ") + "</p>";
                }
            }

            html += "</div>";
            html += `<div class='verification_corrections' style='margin-left: 10px;'><div style='margin-bottom: 10px;'> <label for="checkbox_` + id + `"> Incorrect? </label><input type="checkbox" id="checkbox_` + id + `" name="` + id + `" > </input>  </div>`;
            html += `<div id="expl_` + id + `"><label for="expl_` + id + `_text"> What's wrong: </label><textarea id="expl_` + id + `_text" name="` + id + `" placeholder="Explanation" style='width: 95%;'> </textarea> </div></div>`;

            html += "</div>"; // Close the container element
            return html;
        }

        function isAlphanumeric(str) {
            return str.match(/^[a-zA-Z0-9]+$/) !== null;
        }

        let lang = "jp";
        function replace() {
            let currText = field_names[question_number - 1];

            document.getElementById("text_question").innerHTML = currText;

        }

        function previous() {
            // cache previous responsees
            // document.getElementById("annotation_div" + String(question_number)).innerHTML = document.getElementById("text_annotations").innerHTML; // this doesn't do anything because the innerHTML is not updated

            question_number = question_number - 1;
            document.getElementById("text_question").innerHTML = document.getElementById("question" + String(question_number)).innerHTML;
            document.getElementById("text_annotations").innerHTML = document.getElementById("annotation_div" + String(question_number)).innerHTML;
            replace();
            // populateSelectedItems();
            document.getElementById("submit_hit").disabled = (String(field_names.length) != String(question_number));
            if (String(1) == String(question_number)) {
                document.getElementById("previous_btn").disabled = true;
            }
            if (String(field_names.length) != String(question_number)) {
                document.getElementById("next_btn").disabled = false;
            }
            document.getElementById("qsn_num").innerHTML = question_number + '/' + field_names.length;
        }

        function next() {
            // cache previous response
            // document.getElementById("annotation_div" + String(question_number)).innerHTML = document.getElementById("text_annotations").innerHTML; // this doesn't do anything because the innerHTML is not updated

            question_number = question_number + 1;
            document.getElementById("text_question").innerHTML = document.getElementById("question" + String(question_number)).innerHTML;
            document.getElementById("text_annotations").innerHTML = document.getElementById("annotation_div" + String(question_number)).innerHTML;


            /*
            - maintain a JSON object of sorts to track annotations + comments
            - TODO: make the textareas of checked boxes mandatory
            - scrape all the textareas for their values
            - Throw it into JSON object
        
            JSON object format:
            [
                {
                    text: "I have covid omg"
                    annotation: "lorem ipsum",
                    correct: false
                    explanation: "Lorem ipsum"
                },
                {
                    text: "I have covid omg"
                    annotation: "lorem ipsum",
                    correct: false
                    explanation: "Lorem ipsum"
                },
            ]
            
            and then we can just serialize this as a string
            */

            replace();
            // populateSelectedItems();
            document.getElementById("submit_hit").disabled = (String(field_names.length) != String(question_number));
            if (String(field_names.length) == String(question_number)) {
                document.getElementById("next_btn").disabled = true;
            }
            if (String(1) != String(question_number)) {
                document.getElementById("previous_btn").disabled = false;
            }
            document.getElementById("qsn_num").innerHTML = question_number + '/' + field_names.length;
        }

        function handle_submit() {
            console.log(JSON.stringify(output_obj));

            document.getElementById("master_object").value = JSON.stringify(output_obj);

            console.log(document.getElementById("master_object"));
        }

        const tables = ["small", "arg", "big"];
        const tt_to_ids = { "small": 0, "arg": 1, "big": 2 };

    </script>
    <style>
        sup {
            vertical-align: super;
            font-size: 5.0pt;
        }

        table {
            float: right;
            font-size: 100%;
            height: 30%;
            /*width: 90%;*/
        }

        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
        }
    </style>
</head>

<!-- For the full list of available Crowd HTML Elements and their input/output documentation,
      please refer to https://docs.aws.amazon.com/sagemaker/latest/dg/sms-ui-template-reference.html -->

<!-- You must include crowd-form so that your task submits answers to MTurk -->

<body>
    <crowd-form answer-format="flatten-objects">
        <div class="pager" style="margin-left:30%;">
            <button type="button" style="color:#FFFFFF;background-color:#4CAF50;" id="previous_btn"
                onclick="previous()">&laquo; Previous</button>
            <span id="qsn_num"> </span>
            <button type="button" style="color:#FFFFFF;background-color:#4CAF50;" id="next_btn" onclick="next()">Next
                &raquo;</button>
        </div>

        <crowd-instructions link-text="View instructions" link-type="button">
            <short-summary>
                <p>An Event is defined as something happens in a sentence. Each event may has several arguments, which
                    contain more specific information we are interested in. In this task, we are trying to identify
                    whether one or more of the following events exist in a given string: <i>infect,
                        spread,symptom,prevent,control, cure, and death</i> as well as some of their arguments.
                    <br><br>
                    If an event exists, there will be a major <b>triggering word</b> that mostly manifests its
                    occurrence.
                    We then search for arguments related to this event from the sentence (which may or may not exist).
                    <br><br>
                    For each sentence, we have already marked the Event (if any) and its triggering word, as well as
                    their arguments (if any). Your task is to <b>look through these annotations</b> and check
                    "incorrect" if you disagree with them and write down your opinion.

                    <br><br>
                    Generally, do the three things for each sentence you receive:
                <ol>
                    <li>Look through each event and their arguments, if you agree with everything, move on to the next
                        question.</li>
                    <li>If you think any annotations are incorrect, clicked the ""incorrect"" box and write down your
                        opinion in the box below.</li>
                    <li>If you think current event should not exist or other events should exist in this sentence,
                        clicked the ""incorrect"" box and write down your opinion in the box below.</li>
                </ol>
                <br><br>
                While using your best knowledge to judge does each event and each argument make sense, here are some
                rules specific to this task:
                <ol>

                    <li>If there is explicit negation of an event, that event should not exist. <br>
                        <it>Example:</it> In "This vaccine cannot cure the illness", event cure does not exist.</li>
                    <li>Arguments are not required to be rigorous or specific. <br>
                        Example: "Recently", "at home", "a lot of" are valid time, place, value arguments
                        respectively."</li>
                    <li>One sentence can have multiple events. All annotations will be presented to you at once. <br>
                        <it>Example:</it> In "I wear mask to <b>protect</b> myself from flu but I still <b>got</b> it", both EVENT [prevent] and EVENT
                        [infect] exist.</li>
                    <li>Each event is not required to have all the arguments; arguments not present are left blank.
                    </li>
                    <li>Multiple phrases may share the same argument role. <br>
                        <it>Example:</it> In "Amy and Bob are <b>infected</b> by the virus", "Amy" and "Bob" are both marked as ARGUMENT
                        [infected] of EVENT [infect].</li>

                </ol>
                </p>

                <br><br>

                <h3> Event-Argument Ontology:</h3>
                <div id="arg_table_short">
                    <iframe style="width: 100%; height: 500px;"
                        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxOiv5OtJqAJH5JPDJqd6e5jZ8zg9eyxu3utuNhIm2f0Pto6iY0UFnkffWeQeRJOuAi1647_Ow7NSX/pubhtml?gid=692645370&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
                </div>

            </short-summary>

            <positive-example>
                <iframe style="height: 500px; width:100%;" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxOiv5OtJqAJH5JPDJqd6e5jZ8zg9eyxu3utuNhIm2f0Pto6iY0UFnkffWeQeRJOuAi1647_Ow7NSX/pubhtml?gid=1555479899&amp;single=true&amp;widget=true&amp;headers=false"></iframe>

            </positive-example>

            <negative-example>
                <iframe style="height: 500px; width:100%;" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxOiv5OtJqAJH5JPDJqd6e5jZ8zg9eyxu3utuNhIm2f0Pto6iY0UFnkffWeQeRJOuAi1647_Ow7NSX/pubhtml?gid=1208443491&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
            </negative-example>

        </crowd-instructions>
        <div style="display:flex;">
            <div id="annotate">

                <div>
                    <p style="padding-left:10px;color:red;width:500px;"><b>Please read the instructions before attempting the task</b>. After each example hit the "Next" button at the top of the screen. Once you finish all five examples, please scroll down and click the "Submit HIT" button to complete the task.</p>
                </div>

                <!-- We store the annotations in the 5 pages in these divs -->
                <div id="events" style="display:none;"></div>
                <div id="questions" style="display:none;"></div>
                <div id="annotations" style="display:none;"></div>

                <!-- We store the output in the master object -->
                <crowd-input type="text" style="display:none;" name="master_object" id="master_object"></crowd-input>

                <p style="width:350px; font-size:100%; margin:20px; padding:20px; border:1px solid black;"
                    id="text_question"></p>


                <div>
                    <p style="padding-left:10px;color:#e31818;width:500px;">Check the box if you think the annotation is
                        incorrect, and provide a short point-form answer in the text box below explaining why you think
                        so. <br><br>
                        
                        <u>Important Note</u>:
                        Your answers (both checkings and writings) are <b>automatically saved</b>. If you navigated to previous pages and do not see your answers, they are already saved and you <b>DON'T</b> need to retype. If you do want to edit your answers, just retype in the box.</p>

                    <p style="padding-left:10px;color:#2c18e3;width:350px;">Trigger words and Events:</p>

                    <div id="text_annotations"></div>

                    <button type="submit"
                        style="background-color:#f59d48;font-size:20px; margin-left: 10px; margin-bottom: 20px;"
                        id="submit_hit" disabled onclick="handle_submit()">Submit HIT</button>


                </div>
                <div id="feedback_div" style="width: 200px; padding: 10px; margin: 10px; border:1px solid black;">
                    <p style="margin-bottom: 0px; margin-top: 0px;">Please leave us any feedback about our task or if
                        you would like more clarifications! We appreciate it!</p>
                    <textarea name="feedback"></textarea>
                </div>
            </div>

            <div id="arg_table_2" style="width: 75vw; height: 75vh; padding: 0vw 10vw 0vw 10vw;">
                <iframe style="width: 80%; height: 100%;"
                    src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxOiv5OtJqAJH5JPDJqd6e5jZ8zg9eyxu3utuNhIm2f0Pto6iY0UFnkffWeQeRJOuAi1647_Ow7NSX/pubhtml?gid=692645370&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
            </div>

            <table id="big_table" style="margin-right:20px;margin-left:150px;display:none">
                <tr>
                    <td width="2%"><b>Event</b></td>
                    <td width="12%"><b>Definition and examples</b></td>
                    <td width="22%"><b>Difference between Events</b></td>
                </tr>
                <tr>
                    <td>infect</td>
                    <td><span style="color:blue"> The process of a disease/pathogen invading host(s). </span> <br>
                        eg. "I <b>caught</b> a cold." <br> "Disease is <b>infectious</b>." <br>
                        "New COVID <b>cases</b>."</td>
                    </td>
                    <td rowspan="2">-- Event <i>infect</i> focus on disease's action of invading host(s).<br>
                        -- Event <i>spread</i> focus on disease's action of dispersing.<br>
                        -- Use the focus of triggering word to determine which Event dominates.<br>
                        (eg. COVID infected 1.5 million people in L.A.) Though 1.5 million people infected means COVID
                        is spreading, we mark Event infect because triggering word <b>infected</b> emphasize infection
                        not dispersion.<br>
                    </td>
                </tr>
                <tr>
                    <td>spread</td>
                    <td><span style="color:blue">The process of a disease spreading/pervailing massively at a large
                            scale.</span> <br>
                        eg."Disease <b>sweeps</b> across L.A." "SARS was prevalent in Asia."<br>
                        "To stop the <b>transmission</b> of infection..." </td>
                </tr>
                <tr>
                    <td>symptom</td>
                    <td><span style="color:blue">Individuals displaying physiological features indicating the
                            abnormality of organisms.</span> <br>
                        eg."I <b>got</b> a fever." <br> "I feel <b>sick</b>." <br> "He <b>vomits</b> and <b>cough</b>."
                    </td>
                    <td>-- Event <i>symptoms</i> potentially but not necessarily implies infection of some disease.<br>
                        -- Event <i>infect</i> indicates confirmed infection of some disease.</td>
                </tr>
                <tr>
                    <td>prevent</td>
                    <td> <span style="color:blue"> Individuals trying to prevent the infection of a disease.</span> <br>
                        eg. "tips to <b>avoid</b> catching a cold." <br> "<b>Prevention</b> of infection" <br>
                        "remember COVID <b>protective</b> rules." </td>
                    <td rowspan="2">-- Event <i>prevent</i> focus on preventing disease infection. <br>
                        -- Event <i>control</i> focus on controling disease dispersion. <br>
                        -- Usually Event <i>prevent</i> can be achieved by individual effort, such as "<b>avoid</b>
                        infection", while Event <i>control</i> can NOT be achieved by individual effort, such as
                        "<b>control</b> the spread of COVID."</td>
                </tr>
                <tr>
                    <td>control</td>
                    <td> <span style="color:blue"> Collective efforts trying to impede the spread of a pandemic.</span>
                        <br>
                        eg. "the pandemic can be <b>stopped</b>." <br> "<b>Fight</b> against COVID." <br>
                        "Government failed to <b>slow</b> down the spread of COVID."
                    </td>
                </tr>
                <tr>
                    <td>cure</td>
                    <td> <span style="color:blue"> Stopping infection and relieving individuals from
                            infections/symptoms. </span> <br>
                        eg. "no effective <b>treatment</b> for Covid." <br> "Get <b>rid</b> of a disease." <br>
                        "Can it <b>cure</b> the disease?" </td>
                    <!--<td>"Three steps to get <b>rid</b> of the flu: drink water, keep warm, and rest well."<br>"There is no effective <b>treatment</b> for COVID so far."<br>"Even patients already <b>recovered</b> from COVID remain coughing for a while."</td>-->
                    <td></td>
                </tr>
                <tr>
                    <td>death</td>
                    <td> <span style="color:blue"> End of life of individuals due to infectious disease. </span> <br>
                        eg. "<b>fatality</b> rate is high." <br> "<b>Loss</b> of life during pandemic." <br>
                        "Thousands of people <b>died</b> of SARS 20 years ago." </td>

                    <td>-- Hyperbole and rhetorical expression (eg. I'd rather die than quarantine for a month) does not
                        count as Event <i>death</i>.</td>
                </tr>

            </table>


        </div>
    </crowd-form>
</body>

</html>